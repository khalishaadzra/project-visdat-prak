<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Task 2 - Usia vs Pengalaman vs Stres</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    .tooltip {
      position: absolute;
      background-color: white;
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 4px;
      pointer-events: none;
      font-size: 13px;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
    }
    #legend span {
      display: inline-block;
      margin-right: 10px;
      cursor: pointer;
      padding: 5px 10px;
      border-radius: 4px;
      color: white;
      font-weight: bold;
      margin-bottom: 5px;
    }
  </style>
</head>
<body>

<h2>ðŸŸ© Task 2: Usia vs Pengalaman Kerja vs Tingkat Stres</h2>
<p><em>Klik kategori di bawah untuk filter lokasi kerja.</em></p>
<svg id="scatterplot" width="900" height="600"></svg>
<div class="tooltip" style="display: none;"></div>
<div id="legend"></div>

<script>
  const svg = d3.select("#scatterplot"),
        width = +svg.attr("width"),
        height = +svg.attr("height"),
        margin = {top: 20, right: 40, bottom: 50, left: 60},
        innerWidth = width - margin.left - margin.right,
        innerHeight = height - margin.top - margin.bottom;

  const g = svg.append("g")
               .attr("transform", `translate(${margin.left},${margin.top})`);

  const tooltip = d3.select(".tooltip");

  d3.csv("data/cleaned_data.csv").then(data => {
    data.forEach(d => {
      d.Age = +d.Age;
      d.Years_of_Experience = +d.Years_of_Experience;
      d.Stress_Level = +d.Stress_Level;
    });

    const x = d3.scaleLinear()
                .domain([d3.min(data, d => d.Age) - 2, d3.max(data, d => d.Age) + 2])
                .range([0, innerWidth]);

    const y = d3.scaleLinear()
                .domain([d3.min(data, d => d.Years_of_Experience) - 2, d3.max(data, d => d.Years_of_Experience) + 2])
                .range([innerHeight, 0]);

    const color = d3.scaleSequential(d3.interpolateRdYlGn)
                    .domain([5, 1]);

    const workLocations = Array.from(new Set(data.map(d => d.Work_Location)));
    const activeFilter = { location: null };

    const locationColor = d3.scaleOrdinal()
      .domain(workLocations)
      .range(d3.schemeSet2);

    // X Axis
    g.append("g")
     .attr("transform", `translate(0,${innerHeight})`)
     .call(d3.axisBottom(x))
     .append("text")
     .attr("x", innerWidth / 2)
     .attr("y", 40)
     .attr("fill", "black")
     .attr("text-anchor", "middle")
     .text("Usia");

    // Y Axis
    g.append("g")
     .call(d3.axisLeft(y))
     .append("text")
     .attr("transform", "rotate(-90)")
     .attr("y", -45)
     .attr("x", -innerHeight / 2)
     .attr("fill", "black")
     .attr("text-anchor", "middle")
     .text("Lama Pengalaman Kerja (tahun)");

    // LEGEND
    const legend = d3.select("#legend");

    legend.selectAll("span")
      .data(workLocations)
      .enter()
      .append("span")
      .style("background-color", d => locationColor(d))
      .text(d => d)
      .on("click", (event, loc) => {
        activeFilter.location = (activeFilter.location === loc) ? null : loc;
        updateBubbles();
      });

    function updateBubbles() {
      const filteredData = activeFilter.location
        ? data.filter(d => d.Work_Location === activeFilter.location)
        : data;

      const circles = g.selectAll("circle").data(filteredData, d => d.Employee_ID);

      // EXIT
      circles.exit()
        .transition().duration(300)
        .attr("r", 0)
        .remove();

      // UPDATE
      circles
        .transition().duration(300)
        .attr("cx", d => x(d.Age))
        .attr("cy", d => y(d.Years_of_Experience))
        .attr("fill", d => color(d.Stress_Level));

      // ENTER
      circles.enter()
        .append("circle")
        .attr("cx", d => x(d.Age))
        .attr("cy", d => y(d.Years_of_Experience))
        .attr("r", 0)
        .attr("fill", d => color(d.Stress_Level))
        .attr("opacity", 0.75)
        .on("mouseover", (event, d) => {
          tooltip.style("display", "block")
            .html(`
              <strong>ID:</strong> ${d.Employee_ID}<br>
              <strong>Usia:</strong> ${d.Age}<br>
              <strong>Pengalaman:</strong> ${d.Years_of_Experience} tahun<br>
              <strong>Stres:</strong> ${d.Stress_Level}<br>
              <strong>Lokasi:</strong> ${d.Work_Location}
            `);
        })
        .on("mousemove", event => {
          tooltip
            .style("left", (event.pageX + 10) + "px")
            .style("top", (event.pageY - 20) + "px");
        })
        .on("mouseout", () => tooltip.style("display", "none"))
        .transition().duration(300)
        .attr("r", 4);
    }

    updateBubbles();
  });
</script>

</body>
</html>

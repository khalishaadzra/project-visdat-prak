<!DOCTYPE html>
<html>
  <head>
    <title>Age and Social Isolation Impact on Mental Health</title>
    <link rel="icon" href="data:;base64,iVBORwOKGO=" />
    <style>
      body {
        font-family: "Noto Sans JP", sans-serif;
        font-size: 13px;
        padding: 30px;
        background: #f7f7f7;
      }

      h1 {
        margin-top: 0;
        color: #333;
      }

      #scatterplot {
        max-width: 1000px;
      }

      .source {
        font-size: 10px;
        color: #888;
        margin-top: 10px;
      }

      /* Marks */
      .point:hover {
        stroke: #333;
        stroke-width: 1.5px;
      }

      /* Axes */
      .axis line {
        fill: none;
        stroke: #ddd;
        shape-rendering: crispEdges;
      }
      .axis text {
        font-size: 13px;
        fill: #6b6b6b;
      }
      .axis-title {
        font-size: 13px;
        fill: #888;
        font-weight: bold;
      }
      .y-axis .tick:first-child line {
        stroke: #b1b1b1;
      }
      .x-axis .tick:first-child line {
        display: none;
      }
      .axis path {
        display: none;
      }

      /* Legend */
      .legend {
        margin: 20px 0;
        list-style: none;
        padding: 0;
      }
      .legend-btn {
        display: inline-block;
        margin: 0 20px 0 0;
        cursor: pointer;
        transition: all ease-in-out 200ms;
      }
      .legend-btn:hover.legend-btn.inactive:hover {
        opacity: 0.7;
      }
      .legend-btn.inactive {
        opacity: 0.5;
      }
      .legend-symbol {
        width: 12px;
        height: 12px;
        margin-right: 3px;
        display: inline-block;
      }

      /* Tooltip */
      #tooltip {
        position: absolute;
        display: none;
        background: #fff;
        box-shadow: 3px 3px 3px 0px rgb(92 92 92 / 0.5);
        border: 1px solid #ddd;
        font-size: 12px;
        font-weight: 500;
        padding: 8px;
        min-width: 160px;
        color: #333;
      }
      .tooltip-title {
        color: #000;
        font-size: 14px;
        font-weight: 600;
      }
      #tooltip ul {
        margin: 5px 0 0 0;
        padding-left: 20px;
      }

      .insight-box {
        background: #fff;
        border: 1px solid #ddd;
        padding: 15px;
        margin-top: 20px;
        border-radius: 5px;
        max-width: 1000px;
      }
      
      .insight-title {
        font-weight: bold;
        margin-bottom: 10px;
        color: #333;
      }
    </style>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <h1>Age and Social Isolation Impact on Mental Health</h1>

    <div id="scatterplot"></div>

    <ul class="legend" id="condition-legend"></ul>

    <div class="insight-box">
      <div class="insight-title">Key Insights:</div>
      <div id="insights"></div>
    </div>

    <div class="source">
      Source: Employee Mental Health Dataset (5000 Records)
    </div>

    <div id="tooltip"></div>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
      /**
       * Load data from CSV file asynchronously and render scatter plot
       */
      let data, scatterplot;
      
      // Load the data
      d3.csv("data/cleaned_data.csv")
        .then((_data) => {
          data = _data;
          
          // Convert string values to numbers
          data.forEach((d) => {
            d.Age = +d.Age;
            d.Social_Isolation_Rating = +d.Social_Isolation_Rating;
            // Ensure other numeric fields are properly converted
            d.Stress_Level = +d.Stress_Level;
            d.Work_Life_Balance_Rating = +d.Work_Life_Balance_Rating;
          });

          // Initialize and update the visualization
          scatterplot = new Scatterplot({ parentElement: "#scatterplot" }, data);
          scatterplot.updateVis();
          
          // Generate insights
          generateInsights(data);
        })
        .catch((error) => console.error("Error loading data:", error));

      /**
       * Generate insights from the data
       */
      function generateInsights(data) {
        // Group data by mental health condition
        const conditionGroups = d3.group(data, d => d.Mental_Health_Condition);
        
        // Calculate average age and isolation by condition
        let insights = "Based on the visualization:<ul>";
        
        conditionGroups.forEach((group, condition) => {
          const avgAge = d3.mean(group, d => d.Age).toFixed(1);
          const avgIsolation = d3.mean(group, d => d.Social_Isolation_Rating).toFixed(1);
          const count = group.length;
          const percentage = ((count / data.length) * 100).toFixed(1);
          
          insights += `<li><strong>${condition}</strong>: ${count} employees (${percentage}%) with average age ${avgAge} and isolation rating ${avgIsolation}</li>`;
        });
        
        // Add overall pattern
        const highIsolationGroup = data.filter(d => d.Social_Isolation_Rating >= 4);
        const youngHighIsolation = highIsolationGroup.filter(d => d.Age < 35).length;
        const oldHighIsolation = highIsolationGroup.filter(d => d.Age >= 50).length;
        
        insights += `<li>Among employees with high isolation (rating â‰¥ 4), ${youngHighIsolation} are under 35 years old and ${oldHighIsolation} are 50 or older</li>`;
        insights += "</ul>";
        
        document.getElementById("insights").innerHTML = insights;
      }

      /**
       * Event listeners
       */

      // Listen to window resize event and update the chart
      let pageLoad = true;
      d3.select(window).on("resize", () => {
        if (pageLoad) {
          pageLoad = false;
        } else {
          scatterplot.updateVis();
        }
      });

      class Scatterplot {
        /**
         * Class constructor with basic chart configuration
         * @param {Object}
         * @param {Array}
         */
        constructor(_config, _data) {
          this.config = {
            parentElement: _config.parentElement,
            containerHeight: 500,
            margin: { top: 25, right: 20, bottom: 50, left: 60 },
            tooltipPadding: 15,
            legendHeight: 30
          };
          this.data = _data;
          this.initVis();
        }

        /**
         * We initialize scales/axes and append static elements, such as axis titles.
         */
        initVis() {
          let vis = this;

          // Get unique mental health conditions for color scale
          vis.conditions = [...new Set(vis.data.map(d => d.Mental_Health_Condition))];
          
          // Initialize scales
          vis.colorScale = d3.scaleOrdinal()
            .range(["#5E4FA2", "#3288BD", "#66C2A5", "#ABDDA4", "#E6F598", "#FEE08B", "#FDAE61", "#F46D43", "#D53E4F"])
            .domain(vis.conditions);

          vis.xScale = d3.scaleLinear();
          vis.yScale = d3.scaleLinear();
          
          // Initialize axes
          vis.xAxis = d3.axisBottom(vis.xScale)
            .ticks(10)
            .tickPadding(10);

          vis.yAxis = d3.axisLeft(vis.yScale)
            .ticks(5)
            .tickPadding(10);

          // Define size of SVG drawing area
          vis.svg = d3.select(vis.config.parentElement)
            .append("svg");

          // Append group element that will contain our actual chart
          vis.chart = vis.svg.append("g")
            .attr("transform", `translate(${vis.config.margin.left},${vis.config.margin.top})`);

          // Append empty x-axis group and move it to the bottom of the chart
          vis.xAxisG = vis.chart.append("g")
            .attr("class", "axis x-axis");

          // Append y-axis group
          vis.yAxisG = vis.chart.append("g")
            .attr("class", "axis y-axis");

          // Append axis titles
          vis.chart.append("text")
            .attr("class", "axis-title x-axis-title")
            .attr("text-anchor", "middle")
            .text("Age (years)");
            
          vis.chart.append("text")
            .attr("class", "axis-title y-axis-title")
            .attr("text-anchor", "middle")
            .text("Social Isolation Rating (1-5)");
            
          // Create legend
          this.createLegend();
        }
        
        /**
         * Create a legend for mental health conditions
         */
        createLegend() {
          let vis = this;
          
          const legend = d3.select("#condition-legend");
          
          // Add legend items
          vis.conditions.forEach(condition => {
            const legendItem = legend.append("li")
              .attr("class", "legend-btn")
              .attr("data-condition", condition);
              
            legendItem.append("span")
              .attr("class", "legend-symbol")
              .style("background", vis.colorScale(condition));
              
            legendItem.append("text")
              .text(` ${condition}`);
          });
          
          // Add event listeners to legend items
          d3.selectAll(".legend-btn").on("click", function() {
            // Toggle 'inactive' class
            d3.select(this).classed("inactive", !d3.select(this).classed("inactive"));
            
            // Filter data and update vis
            vis.filterData();
          });
        }
        
        /**
         * Filter data based on selected conditions
         */
        filterData() {
          let vis = this;
          
          // Get active conditions
          let selectedConditions = [];
          d3.selectAll(".legend-btn:not(.inactive)").each(function() {
            selectedConditions.push(d3.select(this).attr("data-condition"));
          });
          
          // Filter data
          if (selectedConditions.length > 0) {
            vis.filteredData = vis.data.filter(d => 
              selectedConditions.includes(d.Mental_Health_Condition)
            );
          } else {
            vis.filteredData = vis.data;
          }
          
          vis.updateVis();
        }

        /**
         * Prepare the data and scales before rendering
         */
        updateVis() {
          let vis = this;
          
          if (!vis.filteredData) {
            vis.filteredData = vis.data;
          }

          // Update dimensions based on the current screen size
          vis.config.containerWidth = document.getElementById(
            vis.config.parentElement.substring(1)
          ).clientWidth;

          // Calculate inner chart size
          vis.config.width = vis.config.containerWidth - vis.config.margin.left - vis.config.margin.right;
          vis.config.height = vis.config.containerHeight - vis.config.margin.top - vis.config.margin.bottom;

          // Update SVG dimensions
          vis.svg
            .attr("width", vis.config.containerWidth)
            .attr("height", vis.config.containerHeight);

          // Update axis positions
          vis.xAxisG.attr("transform", `translate(0,${vis.config.height})`);
          
          // Update axis titles
          vis.chart.select(".x-axis-title")
            .attr("y", vis.config.height + 40)
            .attr("x", vis.config.width / 2);
            
          vis.chart.select(".y-axis-title")
            .attr("transform", `translate(-40,${vis.config.height / 2}) rotate(-90)`);

          // Add grid lines
          vis.xAxis.tickSize(-vis.config.height);
          vis.yAxis.tickSize(-vis.config.width);

          // Set accessor functions
          vis.colorValue = d => d.Mental_Health_Condition;
          vis.xValue = d => d.Age;
          vis.yValue = d => d.Social_Isolation_Rating;
          vis.radiusValue = d => d.Stress_Level;

          // Update scale domains
          vis.xScale
            .range([0, vis.config.width])
            .domain([20, d3.max(vis.filteredData, vis.xValue) + 2])
            .nice();

          vis.yScale
            .range([vis.config.height, 0])
            .domain([0, 5.5])
            .nice();

          vis.renderVis();
        }

        /**
         * Bind data to visual elements
         */
        renderVis() {
          let vis = this;

          // Add jitter to prevent overplotting
          const jitterWidth = 0.5;
          
          // Add circles with jitter for better visualization of overlapping points
          const circles = vis.chart.selectAll(".point")
            .data(vis.filteredData)
            .join("circle")
            .attr("class", "point")
            .attr("r", d => 3 + vis.radiusValue(d) * 0.7)
            .attr("cy", d => vis.yScale(vis.yValue(d) + (Math.random() * jitterWidth - jitterWidth/2)))
            .attr("cx", d => vis.xScale(vis.xValue(d) + (Math.random() * jitterWidth - jitterWidth/2)))
            .attr("fill", d => vis.colorScale(vis.colorValue(d)))
            .attr("opacity", 0.7);

          // Add tooltip functionality
          circles
            .on("mouseover", (event, d) => {
              d3.select("#tooltip")
                .style("display", "block")
                .style("left", (event.pageX + vis.config.tooltipPadding) + "px")
                .style("top", (event.pageY + vis.config.tooltipPadding) + "px")
                .html(`
                  <div class="tooltip-title">Employee: ${d.Employee_ID}</div>
                  <ul>
                    <li>Age: ${d.Age} years</li>
                    <li>Social Isolation: ${d.Social_Isolation_Rating}/5</li>
                    <li>Mental Health: ${d.Mental_Health_Condition}</li>
                    <li>Stress Level: ${d.Stress_Level}/5</li>
                    <li>Sleep Quality: ${d.Sleep_Quality}</li>
                    <li>Work Location: ${d.Work_Location}</li>
                  </ul>
                `);
            })
            .on("mouseleave", () => {
              d3.select("#tooltip").style("display", "none");
            });

          // Update axes
          vis.xAxisG
            .call(vis.xAxis)
            .call(g => g.select(".domain").remove());

          vis.yAxisG
            .call(vis.yAxis)
            .call(g => g.select(".domain").remove());
            
          // Add a trend line to show relationship between age and social isolation
          const trend = vis.calculateTrendLine(vis.filteredData);
          
          vis.chart.selectAll(".trend-line").remove();
          vis.chart.append("line")
            .attr("class", "trend-line")
            .attr("x1", vis.xScale(trend.x1))
            .attr("y1", vis.yScale(trend.y1))
            .attr("x2", vis.xScale(trend.x2))
            .attr("y2", vis.yScale(trend.y2))
            .attr("stroke", "#888")
            .attr("stroke-width", 1.5)
            .attr("stroke-dasharray", "5,5");
        }
        
        /**
         * Calculate a simple trend line
         */
        calculateTrendLine(data) {
          const xMean = d3.mean(data, d => d.Age);
          const yMean = d3.mean(data, d => d.Social_Isolation_Rating);
          
          // Calculate slope and intercept for least squares line
          let numerator = 0;
          let denominator = 0;
          
          data.forEach(d => {
            numerator += (d.Age - xMean) * (d.Social_Isolation_Rating - yMean);
            denominator += Math.pow(d.Age - xMean, 2);
          });
          
          const slope = numerator / denominator;
          const intercept = yMean - (slope * xMean);
          
          // Get points for the line
          const x1 = d3.min(data, d => d.Age);
          const y1 = slope * x1 + intercept;
          const x2 = d3.max(data, d => d.Age);
          const y2 = slope * x2 + intercept;
          
          return { x1, y1, x2, y2 };
        }
      }
    </script>
  </body>
</html>